---
# Source: mutualize/templates/print-pdb.yaml
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: test-mutualize-print
  labels:
    helm.sh/chart: mutualize
    app.kubernetes.io/version: "1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mutualize
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: print
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: mutualize
      app.kubernetes.io/instance: test
      app.kubernetes.io/component: print
---
# Source: mutualize/templates/redirect-pdb.yaml
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: test-mutualize-redirect
  labels:
    helm.sh/chart: mutualize
    app.kubernetes.io/version: "1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mutualize
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: redirect
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: mutualize
      app.kubernetes.io/instance: test
      app.kubernetes.io/component: redirect
---
# Source: mutualize/templates/tilecloudchain-pdb.yaml
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: test-mutualize-tcc
  labels:
    helm.sh/chart: mutualize
    app.kubernetes.io/version: "1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mutualize
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: tcc
spec:
  maxUnavailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: mutualize
      app.kubernetes.io/instance: test
      app.kubernetes.io/component: tcc
---
# Source: mutualize/templates/secret.yaml
apiVersion: v1
kind: Secret
type: Generic
metadata:
  name: test-mutualize
  labels:
    helm.sh/chart: mutualize
    app.kubernetes.io/version: "1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mutualize
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: main
data:
  id_rsa: dG8gYmUgZGVmaW5lZA==
---
# Source: mutualize/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: test-mutualize-env
  labels:
    helm.sh/chart: mutualize
    app.kubernetes.io/version: "1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mutualize
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: main
  annotations:
    {}
data:
  CHART_NAME: mutualize
  RELEASE_NAME: test
  RELEASE_NAMESPACE: default
  INGRESS_HOST: mutualize.local
  CONFIG_PATH: "/"
  CONFIG_IMAGE_TAG: "3.1"
  PRINT_IMAGE_TAG: "latest"
  PRINT_LOGS_IMAGE_TAG: "latest"
  TILECLOUDCHAIN_IMAGE_TAG: "latest"
  CONFIG_SERVICE_NAME: test-mutualize-config
  PRINT_SERVICE_NAME: test-mutualize-print
  PRINT_LOGS_SERVICE_NAME: test-mutualize-logs
  TILECLOUDCHAIN_SERVICE_NAME: test-mutualize-tcc
---
# Source: mutualize/templates/print-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: test-mutualize-print
  labels:
    helm.sh/chart: mutualize
    app.kubernetes.io/version: "1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mutualize
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: print
data:
  web.xml: |
    <?xml version="1.0" encoding="UTF-8"?>

    <web-app xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            version="3.0"
            xmlns="http://java.sun.com/xml/ns/javaee"
            xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd"
            metadata-complete="true">

        <absolute-ordering/>

        <context-param>
            <param-name>contextConfigLocation</param-name>
            <param-value>
                classpath*:mapfish-spring-application-context.xml,classpath:mapfish-spring-security.xml,/WEB-INF/mapfish-print-printer-factory.xml,classpath*:mapfish-spring-application-context-override.xml
            </param-value>
        </context-param>

        <listener>
            <listener-class>org.springframework.web.context.ContextLoaderListener</listener-class>
        </listener>

        <listener>
            <listener-class>org.mapfish.print.metrics.MetricsRegistryContextListener</listener-class>
        </listener>

        <listener>
            <listener-class>org.mapfish.print.metrics.HealthCheckRegistryContextListener</listener-class>
        </listener>

        <listener>
            <listener-class>org.mapfish.print.metrics.MapfishPrintInstrumentedFilterContextListener
            </listener-class>
        </listener>

        <filter>
            <filter-name>requestSizeFilter</filter-name>
            <filter-class>org.mapfish.print.servlet.RequestSizeFilter</filter-class>
            <init-param>
                <!-- The maximum request size in bytes (default: 1 MB). -->
                <param-name>maxContentLength</param-name>
                <param-value>1048576</param-value>
            </init-param>
        </filter>
        <filter-mapping>
            <filter-name>requestSizeFilter</filter-name>
            <url-pattern>/print/*</url-pattern>
        </filter-mapping>

        <filter>
            <filter-name>characterEncodingFilter</filter-name>
            <filter-class>org.springframework.web.filter.CharacterEncodingFilter</filter-class>
            <init-param>
                <param-name>encoding</param-name>
                <param-value>UTF-8</param-value>
            </init-param>
        </filter>
        <filter-mapping>
            <filter-name>characterEncodingFilter</filter-name>
            <url-pattern>/print/*</url-pattern>
        </filter-mapping>

        <filter>
            <filter-name>springSecurityFilterChain</filter-name>
            <filter-class>org.springframework.web.filter.DelegatingFilterProxy</filter-class>
        </filter>

        <filter-mapping>
            <filter-name>springSecurityFilterChain</filter-name>
            <url-pattern>/print/*</url-pattern>
        </filter-mapping>

        <filter>
            <filter-name>instrumentedFilter</filter-name>
            <filter-class>com.codahale.metrics.servlet.InstrumentedFilter</filter-class>
        </filter>
        <filter-mapping>
            <filter-name>instrumentedFilter</filter-name>
            <url-pattern>/print/*</url-pattern>
        </filter-mapping>

        <filter>
            <filter-name>CORS</filter-name>
            <filter-class>com.thetransactioncompany.cors.CORSFilter</filter-class>
            <init-param>
                <param-name>cors.supportedMethods</param-name>
                <param-value>GET, POST, DELETE, HEAD, OPTIONS</param-value>
            </init-param>
            <init-param>
                <param-name>cors.maxAge</param-name>
                <param-value>86400</param-value>
            </init-param>
            <init-param>
                <param-name>cors.supportsCredentials</param-name>
                <param-value>false</param-value>
            </init-param>
        </filter>
        <filter-mapping>
            <filter-name>CORS</filter-name>
            <url-pattern>/print/*</url-pattern>
        </filter-mapping>

        <servlet>
            <servlet-name>metrics-servlet</servlet-name>
            <servlet-class>com.codahale.metrics.servlets.AdminServlet</servlet-class>
        </servlet>

        <!-- single mapping to spring, this only works properly if the advanced dispatch filter is
            active -->
        <servlet-mapping>
            <servlet-name>metrics-servlet</servlet-name>
            <url-pattern>/print/metrics</url-pattern>
        </servlet-mapping>
        <servlet-mapping>
            <servlet-name>metrics-servlet</servlet-name>
            <url-pattern>/print/metrics/*</url-pattern>
        </servlet-mapping>

        <servlet>
            <servlet-name>mapfish-print</servlet-name>
            <servlet-class>org.springframework.web.servlet.DispatcherServlet</servlet-class>
            <load-on-startup>1</load-on-startup>
        </servlet>

        <servlet-mapping>
            <servlet-name>mapfish-print</servlet-name>
            <url-pattern>/print/print/*</url-pattern>
        </servlet-mapping>

        <servlet-mapping>
            <servlet-name>mapfish-print</servlet-name>
            <url-pattern>/print/sec/print/*</url-pattern>
        </servlet-mapping>

    </web-app>
---
# Source: mutualize/templates/tilecloudchain-configmap-mainconfig.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: test-mutualize-tcc-main-config
  labels:
    helm.sh/chart: mutualize
    app.kubernetes.io/version: "1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mutualize
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: tcc
data:
  config.yaml: |
    test: 111
    toto: 222
---
# Source: mutualize/templates/logs-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: test-mutualize-logs
  labels:
    helm.sh/chart: mutualize
    app.kubernetes.io/version: "1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mutualize
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: logs
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: mutualize
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: logs
---
# Source: mutualize/templates/print-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: test-mutualize-print
  labels:
    helm.sh/chart: mutualize
    app.kubernetes.io/version: "1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mutualize
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: print
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: mutualize
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: print
---
# Source: mutualize/templates/redirect-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: test-mutualize-redirect
  labels:
    helm.sh/chart: mutualize
    app.kubernetes.io/version: "1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mutualize
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: redirect
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: mutualize
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: redirect
---
# Source: mutualize/templates/shared-config-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: test-mutualize-config
  labels:
    helm.sh/chart: mutualize
    app.kubernetes.io/version: "1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mutualize
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: config
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: mutualize
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: config
---
# Source: mutualize/templates/tilecloudchain-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: test-mutualize-tcc
  labels:
    helm.sh/chart: mutualize
    app.kubernetes.io/version: "1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mutualize
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: tcc
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: mutualize
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: tcc
---
# Source: mutualize/templates/print-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-mutualize-print
  labels:
    helm.sh/chart: mutualize
    app.kubernetes.io/version: "1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mutualize
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: print
spec:
  replicas:
  revisionHistoryLimit: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 25%
  selector:
    matchLabels:
      app.kubernetes.io/name: mutualize
      app.kubernetes.io/instance: test
      app.kubernetes.io/component: print
  template:
    metadata:
      labels:
        app.kubernetes.io/name: mutualize
        app.kubernetes.io/instance: test
        app.kubernetes.io/component: print
    spec:
      serviceAccountName: default
      securityContext:
        runAsNonRoot: true
        runAsUser: 33
      affinity:
        {}
      containers:
        - name: config
          securityContext:
            runAsNonRoot: true
            runAsUser: 33
          image: "camptocamp/shared_config_manager:latest"
          imagePullPolicy: IfNotPresent
          env:
            - name: "TAG_FILTER"
              value: "print"
            - name: "TARGET"
              value: "/config"
          terminationMessagePolicy: FallbackToLogsOnError
          resources:
            {}
          args: ['shared-config-slave']
          volumeMounts:
            - mountPath: /config
              name: configs
            - name: masterconfig
              readOnly: true
              mountPath: /etc/shared_config_manager
          readinessProbe: &configProbe
            exec:
              command:
                - scm-is-ready
            initialDelaySeconds: 30
            periodSeconds: 30
            failureThreshold: 5
          livenessProbe:
            <<: *configProbe
            periodSeconds: 120
        - name: print
          securityContext:
            runAsNonRoot: true
            runAsUser: 33
          image: "camptocamp/mapfish_print:latest"
          imagePullPolicy: IfNotPresent
          terminationMessagePolicy: FallbackToLogsOnError
          resources:
            {}
          command:
            - aaa
          args:
            - bbb
            - ccc
          volumeMounts:
            - name: configs
              mountPath: /usr/local/tomcat/webapps/ROOT/print-apps
            - name: web-xml
              mountPath: /usr/local/tomcat/webapps/ROOT/WEB-INF/web.xml
              subPath: web.xml
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          readinessProbe:
            httpGet:
              path: /print/metrics/ping?health_check=true
              port: http
            initialDelaySeconds: 15
            periodSeconds: 30
          livenessProbe:
            exec:
              # Be sure that the EPSG 2056 exists, see: https://jira.camptocamp.com/browse/GSGMF-1606
              command:
                - curl
                - http://localhost:8080/print/examples:simple/buildreport.pdf
                - --data-raw
                - spec=%7B%0D%0A++++%22layout%22%3A+%22A4+portrait%22%2C%0D%0A++++%22attributes%22%3A+%7B%22map%22%3A+%7B%0D%0A++++++++%22center%22%3A+%5B%0D%0A++++++++++++1200000%2C%0D%0A++++++++++++2600000%0D%0A++++++++%5D%2C%0D%0A++++++++%22rotation%22%3A+0%2C%0D%0A++++++++%22longitudeFirst%22%3A+true%2C%0D%0A++++++++%22layers%22%3A+%5B%5D%2C%0D%0A++++++++%22scale%22%3A+100000000%2C%0D%0A++++++++%22projection%22%3A+%22EPSG%3A2056%22%2C%0D%0A++++++++%22dpi%22%3A+72%0D%0A++++%7D%7D%0D%0A%7D
            initialDelaySeconds: 15
            failureThreshold: 50
            periodSeconds: 120
          lifecycle:
            preStop:
              exec:
                command: ['/bin/bash', '-c', '/usr/local/tomcat/bin/docker_pre_stop_print.sh $(PRINT_TERMINATION_GRACE_PERIOD_SECONDS) || true']
      volumes:
        - name: configs
          emptyDir: {}
        - name: masterconfig
          configMap:
            name: test-mutualize-config
        - name: web-xml
          configMap:
            name: test-mutualize-print
            items:
              - key: web.xml
                path: web.xml
---
# Source: mutualize/templates/redirect-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-mutualize-redirect
  labels:
    helm.sh/chart: mutualize
    app.kubernetes.io/version: "1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mutualize
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: redirect
spec:
  replicas: 1
  revisionHistoryLimit: 3
  strategy:
    type: RollingUpdate
  selector:
    matchLabels:
      app.kubernetes.io/name: mutualize
      app.kubernetes.io/instance: test
      app.kubernetes.io/component: redirect
  template:
    metadata:
      labels:
        app.kubernetes.io/name: mutualize
        app.kubernetes.io/instance: test
        app.kubernetes.io/component: redirect
    spec:
      serviceAccountName: default
      securityContext:
        runAsNonRoot: true
        runAsUser: 33
      affinity:
        {}
      containers:
        - name: redirect
          securityContext:
            runAsNonRoot: true
            runAsUser: 33
          image: "camptocamp/redirect:latest"
          imagePullPolicy: IfNotPresent
          terminationMessagePolicy: FallbackToLogsOnError
          resources:
            {}
          volumeMounts:
            - name: hosts
              mountPath: /etc/redirect
            - mountPath: /tmp
              name: tmp-volume
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          readinessProbe:
            httpGet:
              path: /tiles/c2c/health_check
              port: http
            initialDelaySeconds: 5
            timeoutSeconds: 10
            periodSeconds: 15
          livenessProbe:
            httpGet:
              path: /tiles/c2c/health_check
              port: http
            initialDelaySeconds: 5
            timeoutSeconds: 10
            periodSeconds: 60
      volumes:
        - name: tmp-volume
          emptyDir: {}
        - name: hosts
          configMap:
            name: test-mutualize-redirect-hosts
---
# Source: mutualize/templates/shared-config-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-mutualize-config
  labels:
    helm.sh/chart: mutualize
    app.kubernetes.io/version: "1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mutualize
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: config
spec:
  replicas: 1
  revisionHistoryLimit: 3
  strategy:
    type: RollingUpdate
  selector:
    matchLabels:
      app.kubernetes.io/name: mutualize
      app.kubernetes.io/instance: test
      app.kubernetes.io/component: config
  template:
    metadata:
      labels:
        app.kubernetes.io/name: mutualize
        app.kubernetes.io/instance: test
        app.kubernetes.io/component: config
    spec:
      serviceAccountName: default
      securityContext:
        runAsNonRoot: true
        runAsUser: 33
      affinity:
        {}
      containers:
        - name: shared-config
          securityContext:
            runAsNonRoot: true
            runAsUser: 33
          image: "camptocamp/shared_config_manager:3.1"
          imagePullPolicy: IfNotPresent
          env:
            - name: "C2C_REDIS_TIMEOUT"
              value: "30"
            - name: "C2C_SECRET"
              value: "secret"
            - name: "CONFIG_SERVICE_NAME"
              valueFrom:
                configMapKeyRef:
                  name: "test-mutualize-env"
                  key: "CONFIG_SERVICE_NAME"
            - name: "LOG_LEVEL"
              value: "DEBUG"
            - name: "LOG_TYPE"
              value: "console"
            - name: "MASTER_CONFIG"
              value: ""
            - name: "REDIS_DB"
              value: "1"
            - name: "SCM_ENV_PREFIXES"
              value: "TEST_"
            - name: "API_BASE_URL"
              value: "http://$(CONFIG_SERVICE_NAME):8080/"
            - name: "C2C_BROADCAST_PREFIX"
              value: "broadcast_config_$(REDIS_DB)_"
            - name: "C2C_REDIS_URL"
              value: "redis://test-redis-master/$(REDIS_DB)"
          terminationMessagePolicy: FallbackToLogsOnError
          resources:
            {}
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          readinessProbe:
            httpGet:
              path: /c2c/health_check
              port: http
            initialDelaySeconds: 10
          volumeMounts:
            - name: ssh-key
              readOnly: true
              mountPath: /var/www/.ssh2
            - name: masterconfig
              readOnly: true
              mountPath: /etc/shared_config_manager
      volumes:
        - name: ssh-key
          secret:
            secretName: test-mutualize
            defaultMode: 0440
        - name: masterconfig
          configMap:
            name: test-mutualize-config
---
# Source: mutualize/templates/tilecloudchain-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-mutualize-tcc
  labels:
    helm.sh/chart: mutualize
    app.kubernetes.io/version: "1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mutualize
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: tcc
spec:
  replicas: 1
  revisionHistoryLimit: 3
  strategy:
    type: RollingUpdate
  selector:
    matchLabels:
      app.kubernetes.io/name: mutualize
      app.kubernetes.io/instance: test
      app.kubernetes.io/component: tcc
  template:
    metadata:
      labels:
        app.kubernetes.io/name: mutualize
        app.kubernetes.io/instance: test
        app.kubernetes.io/component: tcc
        foo: bar
    spec:
      serviceAccountName: default
      securityContext:
        runAsNonRoot: true
        runAsUser: 33
      affinity:
        {}
      containers:
        - name: config
          securityContext:
            runAsNonRoot: true
            runAsUser: 33
          image: "camptocamp/shared_config_manager:3.1"
          imagePullPolicy: IfNotPresent
          env:
            - name: "C2C_REDIS_TIMEOUT"
              value: "30"
            - name: "C2C_SECRET"
              value: "secret"
            - name: "CONFIG_SERVICE_NAME"
              valueFrom:
                configMapKeyRef:
                  name: "test-mutualize-env"
                  key: "CONFIG_SERVICE_NAME"
            - name: "LOG_LEVEL"
              value: "DEBUG"
            - name: "LOG_TYPE"
              value: "console"
            - name: "MASTER_CONFIG"
              value: "type: git\nrepo: 'https://github.com/camptocamp/helm-mutualize.git'\nbranch: master\nkey: secret\nsub_dir: tests/shared-config\nsparse: false\n"
            - name: "REDIS_DB"
              value: "1"
            - name: "TAG_FILTER"
              value: "tilecloudchain"
            - name: "TARGET"
              value: "/config"
            - name: "API_BASE_URL"
              value: "http://$(CONFIG_SERVICE_NAME):8080/"
            - name: "C2C_BROADCAST_PREFIX"
              value: "broadcast_config_$(REDIS_DB)_"
            - name: "C2C_REDIS_URL"
              value: "redis://test-redis-master/$(REDIS_DB)"
          terminationMessagePolicy: FallbackToLogsOnError
          resources:
            {}
          args: ['shared-config-slave']
          readinessProbe: &configProbe
            exec:
              command:
                - scm-is-ready
            initialDelaySeconds: 30
            periodSeconds: 30
            failureThreshold: 5
          livenessProbe:
            <<: *configProbe
            periodSeconds: 120
          volumeMounts:
            - name: configs
              mountPath: /config
            - name: masterconfig
              readOnly: true
              mountPath: /etc/shared_config_manager
        - name: tilecloudchain
          securityContext:
            runAsNonRoot: true
            runAsUser: 33
          image: "camptocamp/tilecloud-chain:latest"
          imagePullPolicy: IfNotPresent
          env:
            - name: "C2C_SECRET"
              value: "secret"
            - name: "REDIS_DB"
              value: "3"
            - name: "TILEGENERATION_HOSTSFILE"
              value: "/etc/tilecloudchain-hosts/hosts.yaml"
            - name: "TILEGENERATION_MAIN_CONFIGFILE"
              value: "/etc/tilecloudchain-main/config.yaml"
            - name: "C2C_BROADCAST_PREFIX"
              value: "broadcast_scm_$(REDIS_DB)_"
            - name: "C2C_REDIS_URL"
              value: "redis://test-redis-master/$(REDIS_DB)"
          terminationMessagePolicy: FallbackToLogsOnError
          resources:
            {}
          volumeMounts:
            - name: configs
              mountPath: /etc/tilecloudchain-configs
            - name: hosts
              mountPath: /etc/tilecloudchain-hosts
            - name: mainconfig
              mountPath: /etc/tilecloudchain-main
            - mountPath: /tmp
              name: tmp-volume
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          readinessProbe:
            httpGet:
              path: /tiles/c2c/health_check
              port: http
            initialDelaySeconds: 5
            timeoutSeconds: 10
            periodSeconds: 15
          livenessProbe:
            httpGet:
              path: /tiles/c2c/health_check
              port: http
            initialDelaySeconds: 5
            timeoutSeconds: 10
            periodSeconds: 60
      volumes:
        - name: configs
          emptyDir: {}
        - name: tmp-volume
          emptyDir: {}
        - name: hosts
          configMap:
            name: test-mutualize-tcc-hosts
        - name: mainconfig
          configMap:
            name: test-mutualize-tcc-main-config
        - name: masterconfig
          configMap:
            name: test-mutualize-config
---
# Source: mutualize/templates/tilecloudchain-slave-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-mutualize-tcc-slave
  labels:
    helm.sh/chart: mutualize
    app.kubernetes.io/version: "1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mutualize
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: tcc-slave
spec:
  replicas: 1
  revisionHistoryLimit: 3
  strategy:
    type: RollingUpdate
  selector:
    matchLabels:
      app.kubernetes.io/name: mutualize
      app.kubernetes.io/instance: test
      app.kubernetes.io/component: tcc-slave
  template:
    metadata:
      labels:
        app.kubernetes.io/name: mutualize
        app.kubernetes.io/instance: test
        app.kubernetes.io/component: tcc-slave
        foo: bar
    spec:
      serviceAccountName: default
      securityContext:
        runAsNonRoot: true
        runAsUser: 33
      affinity:
        {}
      containers:
        - name: config
          securityContext:
            runAsNonRoot: true
            runAsUser: 33
          image: "camptocamp/shared_config_manager:3.1"
          imagePullPolicy: IfNotPresent
          env:
            - name: "C2C_REDIS_TIMEOUT"
              value: "30"
            - name: "C2C_SECRET"
              value: "secret"
            - name: "CONFIG_SERVICE_NAME"
              valueFrom:
                configMapKeyRef:
                  name: "test-mutualize-env"
                  key: "CONFIG_SERVICE_NAME"
            - name: "LOG_LEVEL"
              value: "DEBUG"
            - name: "LOG_TYPE"
              value: "console"
            - name: "MASTER_CONFIG"
              value: "type: git\nrepo: 'https://github.com/camptocamp/helm-mutualize.git'\nbranch: master\nkey: secret\nsub_dir: tests/shared-config\nsparse: false\n"
            - name: "REDIS_DB"
              value: "1"
            - name: "TAG_FILTER"
              value: "tilecloudchain"
            - name: "TARGET"
              value: "/config"
            - name: "API_BASE_URL"
              value: "http://$(CONFIG_SERVICE_NAME):8080/"
            - name: "C2C_BROADCAST_PREFIX"
              value: "broadcast_config_$(REDIS_DB)_"
            - name: "C2C_REDIS_URL"
              value: "redis://test-redis-master/$(REDIS_DB)"
          terminationMessagePolicy: FallbackToLogsOnError
          resources:
            {}
          args: ['shared-config-slave']
          readinessProbe: &configProbe
            exec:
              command:
                - scm-is-ready
            initialDelaySeconds: 30
            periodSeconds: 30
            failureThreshold: 5
          livenessProbe:
            <<: *configProbe
            periodSeconds: 120
          volumeMounts:
            - name: configs
              mountPath: /config
            - name: masterconfig
              readOnly: true
              mountPath: /etc/shared_config_manager
        - name: tilecloudchain
          securityContext:
            runAsNonRoot: true
            runAsUser: 33
          image: "camptocamp/tilecloud-chain:latest"
          imagePullPolicy: IfNotPresent
          env:
            - name: "C2C_SECRET"
              value: "secret"
            - name: "REDIS_DB"
              value: "3"
            - name: "TILEGENERATION_HOSTSFILE"
              value: "/etc/tilecloudchain-hosts/hosts.yaml"
            - name: "TILEGENERATION_MAIN_CONFIGFILE"
              value: "/etc/tilecloudchain-main/config.yaml"
            - name: "C2C_BROADCAST_PREFIX"
              value: "broadcast_scm_$(REDIS_DB)_"
            - name: "C2C_REDIS_URL"
              value: "redis://test-redis-master/$(REDIS_DB)"
          terminationMessagePolicy: FallbackToLogsOnError
          resources:
            {}
          args: ["generate_tiles", "--role=slave", "--daemon"]
          volumeMounts:
            - name: configs
              mountPath: /etc/tilecloudchain-configs
            - name: hosts
              mountPath: /etc/tilecloudchain-hosts
            - name: mainconfig
              mountPath: /etc/tilecloudchain-main
            - mountPath: /tmp
              name: tmp-volume
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
      volumes:
        - name: configs
          emptyDir: {}
        - name: tmp-volume
          emptyDir: {}
        - name: hosts
          configMap:
            name: test-mutualize-tcc-hosts
        - name: mainconfig
          configMap:
            name: test-mutualize-tcc-main-config
        - name: masterconfig
          configMap:
            name: test-mutualize-config
---
# Source: mutualize/templates/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: test-mutualize-main
  labels:
    helm.sh/chart: mutualize
    app.kubernetes.io/version: "1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mutualize
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: main
spec:
  tls:
    - hosts:
        - mutualize.local
      secretName: test-tls
  rules:
    - host: mutualize.local
      http:
        paths:
          - path: /print
            pathType: Prefix
            backend:
              service:
                name: test-mutualize-print
                port:
                  number: 80
          - path: /print/logs
            pathType: Prefix
            backend:
              service:
                name: test-mutualize-logs
                port:
                  number: 80
          - path: /config
            pathType: Prefix
            backend:
              service:
                name: test-mutualize-config
                port:
                  number: 80
          - path: /test/print
            pathType: Prefix
            backend:
              service:
                name: test-mutualize-print
                port:
                  number: 80
          - path: /test/print/logs
            pathType: Prefix
            backend:
              service:
                name: test-mutualize-logs
                port:
                  number: 80
          - path: /test/config
            pathType: Prefix
            backend:
              service:
                name: test-mutualize-config
                port:
                  number: 80
---
# Source: mutualize/templates/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: test-mutualize-prod
  labels:
    helm.sh/chart: mutualize
    app.kubernetes.io/version: "1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mutualize
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: main
spec:
  tls:
    - hosts:
        - mutualize.prod.local
      secretName: test-prod-tls
  rules:
    - host: mutualize.prod.local
      http:
        paths:
          - path: /print
            pathType: Prefix
            backend:
              service:
                name: test-mutualize-print
                port:
                  number: 80
          - path: /print/logs
            pathType: Prefix
            backend:
              service:
                name: test-mutualize-logs
                port:
                  number: 80
          - path: /config
            pathType: Prefix
            backend:
              service:
                name: test-mutualize-config
                port:
                  number: 80
          - path: /test/print
            pathType: Prefix
            backend:
              service:
                name: test-mutualize-print
                port:
                  number: 80
          - path: /test/print/logs
            pathType: Prefix
            backend:
              service:
                name: test-mutualize-logs
                port:
                  number: 80
          - path: /test/config
            pathType: Prefix
            backend:
              service:
                name: test-mutualize-config
                port:
                  number: 80
---
# Source: mutualize/templates/redirect-config.yaml
apiVersion: camptocamp.com/v2
kind: SharedConfigConfig
metadata:
  name: test-mutualize-redirect-hosts
  labels:
    helm.sh/chart: mutualize
    app.kubernetes.io/version: "1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mutualize
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: redirect
spec:
  environment: prod
  matchLabels:
    mutualize-redirect-hosts: 'true'
  configmapName: hosts.yaml
  property: sources
---
# Source: mutualize/templates/shared-config-config.yaml
apiVersion: camptocamp.com/v2
kind: SharedConfigConfig
metadata:
  name: test-mutualize-config
  labels:
    helm.sh/chart: mutualize
    app.kubernetes.io/version: "1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mutualize
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: config
spec:
  environment: prod
  matchLabels:
    mutualize-sharedconfig: 'true'
  property: sources
  configmapName: config.yaml
---
# Source: mutualize/templates/tilecloudchain-config-hosts.yaml
apiVersion: camptocamp.com/v2
kind: SharedConfigConfig
metadata:
  name: test-mutualize-tcc-hosts
  labels:
    helm.sh/chart: mutualize
    app.kubernetes.io/version: "1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mutualize
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: tcc
spec:
  environment: prod
  matchLabels:
    mutualize-tilecloudchain-hosts: 'true'
  configmapName: hosts.yaml
  property: sources
---
# Source: mutualize/templates/sharedconfig.yaml
apiVersion: camptocamp.com/v2
kind: SharedConfigSource
metadata:
  name: test-mutualize-examples
  labels:
    helm.sh/chart: mutualize
    app.kubernetes.io/version: "1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mutualize
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: main
spec:
  environment: prod
  name: examples
  content:
      type: git
      repo: git@github.com:mapfish/mapfish-print.git
      key: super-secret
      template_engines:
        - type: shell
          environment_variables: true
---
# Source: mutualize/templates/sharedconfig.yaml
apiVersion: camptocamp.com/v2
kind: SharedConfigSource
metadata:
  name: test-mutualize-examples2
  labels:
    helm.sh/chart: mutualize
    app.kubernetes.io/version: "1.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: mutualize
    app.kubernetes.io/instance: test
    app.kubernetes.io/component: main
    mutualize-sharedconfig: "true"
spec:
  environment: prod
  name: examples2
  content:
      type: git
      repo: git@github.com:mapfish/mapfish-print.git
      branch: master
      key: super-secret
      sub_dir: examples/src/test/resources/examples
      tags:
        - print
      template_engines:
        - type: shell
          environment_variables: true
          data:
            - name: "TOTO"
              value: "toto"
